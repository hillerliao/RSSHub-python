{% extends "layout.html" %}
{% block title %}RSS Feeds Status{% endblock title %}
{% block content %}
<div class="container-fluid">
    <h2>RSS Feeds Status</h2>
    <p>This page shows the status of all RSS feeds. It checks if the feeds are returning content properly.</p>

    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Feed Name</th>
                    <th>Route</th>
                    <th>Status</th>
                    <th>Last Checked</th>
                    <th>Items Count</th>
                </tr>
            </thead>
            <tbody id="statusTableBody">
                <!-- Status rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <button id="checkStatusBtn" class="btn btn-primary">Check Status Now</button>
    <div id="loadingIndicator" class="mt-2" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <span class="ml-2">Checking status...</span>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Define the feeds to check
        const feeds = [
            { name: 'ASMR Works', route: '/asmr/works' },
            { name: 'RSS Filter', route: '/filter?feed=https://sspai.com/feed' },
            { name: 'The Economist World Brief', route: '/economist/worldbrief' },
            { name: 'Nasdaq Symbol Change', route: '/nasdaq/symbol_change' },
            { name: 'NHK News Easy', route: '/nhk/newseasy' },
            { name: 'EMagazine', route: '/emagazine' },
            { name: 'Baidu Suggest', route: '/baidu/suggest/weishenme' },
            { name: 'HNZCY Bidding', route: '/hnzcy/bidding/Newest' },
            { name: 'BBWC Realtime', route: '/bbwc/realtime/2' },
            { name: 'App Store Top', route: '/appstore/top/us/36' },
            { name: 'InfoQ Recommend', route: '/infoq/recommend' },
            { name: 'Readhub Topic', route: '/readhub/topic/10/0acaf84bdef38ea9' },
            { name: 'Futu Live', route: '/futu/live/zh-cn' },
            { name: 'DXZG Notice', route: '/dxzg/notice' },
            { name: 'Earnings Date Businesswire', route: '/earningsdate/businesswire' },
            { name: 'Jiemian Newsflash', route: '/jiemian/newsflash/166' },
            { name: 'Caixin Scroll', route: '/caixin/scroll/125' },
            { name: 'Netease Comment', route: '/netease/comment/heated' },
            { name: 'Aisixiang Search', route: '/aisixiang/search/author/郑永年' },
            { name: 'Eastmoney Report', route: '/eastmoney/report/stock/473' },
            { name: 'Xuangubao Theme', route: '/xuangubao/theme/17006066' },
            { name: 'CLS Subject', route: '/cls/subject/1345' },
            { name: 'Chaindd Column', route: '/chaindd/column/3158465' },
            { name: 'Zaobao Realtime', route: '/zaobao/realtime/china' },
            { name: 'Techcrunch Tag', route: '/techcrunch/tag/216504' },
            { name: 'Weiyangx Home', route: '/weiyangx/home' },
            { name: 'YFChuhai Express', route: '/yfchuhai/express' },
            { name: 'Jintiankansha Column', route: '/jintiankansha/column/KgkNwnDrsy' },
            { name: 'Interotc CPGG', route: '/interotc/cpgg/东兴证券' },
            { name: 'Benzinga Ratings', route: '/benzinga/ratings/wb' },
            { name: 'Chouti User', route: '/chouti/user/wb_5517143496' },
            { name: 'Chouti Section', route: '/chouti/section/1116' },
            { name: 'Chouti Search', route: '/chouti/search/China' },
            { name: 'MP Tag', route: '/mp/tag/MzI5MjM3OTA0MA/1500461858015772673' },
            { name: 'MP rTag', route: '/mp/rtag/MzI5MjM3OTA0MA/1500461858015772673' },
            { name: 'Producthunt Search', route: '/producthunt/search/wechat/30' },
            { name: 'Pgyer App', route: '/pgyer/22bY' },
            { name: 'BJ News', route: '/bjnews/beijing' },
            { name: 'Xinhuanet Latest', route: '/xinhuanet/zuixinbobao' },
            { name: 'Xinhuanet Shizheng', route: '/xinhuanet/shizhenglianbo' },
            { name: 'Xinhuanet Yaodian', route: '/xinhuanet/yaodianjujiao' },
            { name: 'Xinhuanet World', route: '/xinhuanet/world' },
            { name: 'MP GH', route: '/mp/gh/mao-talk' },
            { name: 'Zhihu Explore', route: '/zhihu/explore' },
            { name: 'Xueqiu User', route: '/xueqiu/user/1247347556' },
            { name: 'Qieman Portfolio', route: '/qieman/po_adjust/SI000108' },
            { name: 'Random Word', route: '/randomword/sentence' },
            { name: 'Random Line', route: '/randomline' },
            { name: 'HF Dataset', route: '/hf_dataset' },
            { name: 'CNINFO Announcement', route: '/cninfo/announcement/000001/szse' },
            { name: 'Chuansongme', route: '/chuansongme/articles/tech' },
            { name: 'Ctolib Topics', route: '/ctolib/topics/new' },
            { name: 'Tadoku Books', route: '/tadoku/books/0' },
            { name: 'NHK Topic', route: '/nhk/topic/1' },
            { name: 'Sysu Ifcen', route: '/sysu/ifcen/1' },
            { name: 'Earnings Prnewswire', route: '/earningsdate/prnewswire' },
            { name: 'Earnings Globe', route: '/earningsdate/globenewswire' },
            { name: 'CSRC Audit', route: '/csrc/audit/0' },
            { name: 'CLS Telegraph', route: '/cls/telegraph/' },
            { name: 'Weiyangx Express', route: '/weiyangx/express/' }
        ];

        const statusTableBody = document.getElementById('statusTableBody');
        const checkStatusBtn = document.getElementById('checkStatusBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Initialize table with feed names and routes
        feeds.forEach(feed => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${feed.name}</td>
                <td><a href="${feed.route}" target="_blank">${feed.route}</a></td>
                <td><span class="badge badge-secondary">Unknown</span></td>
                <td>N/A</td>
                <td>N/A</td>
            `;
            statusTableBody.appendChild(row);
        });

        // Function to check status of all feeds
        async function checkStatus() {
            loadingIndicator.style.display = 'block';
            const rows = statusTableBody.querySelectorAll('tr');

            for (let i = 0; i < feeds.length; i++) {
                const feed = feeds[i];
                const row = rows[i];
                const statusCell = row.cells[2];
                const lastCheckedCell = row.cells[3];
                const itemCountCell = row.cells[4];

                try {
                    statusCell.innerHTML = '<span class="badge badge-warning">Checking...</span>';

                    const startTime = new Date().getTime();
                    const response = await fetch(feed.route, { method: 'GET', redirect: 'follow' });
                    const endTime = new Date().getTime();

                    const now = new Date();
                    const timeString = now.toLocaleTimeString();

                    if (response.ok) {
                        // Try to get item count if it's an XML response
                        try {
                            const text = await response.text();
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(text, "text/xml");

                            // Try different possible selectors for RSS items
                            let items = xmlDoc.querySelectorAll('item');
                            if (items.length === 0) {
                                items = xmlDoc.querySelectorAll('entry');
                            }

                            statusCell.innerHTML = `<span class="badge badge-success">OK (${endTime - startTime}ms)</span>`;
                            lastCheckedCell.textContent = timeString;
                            itemCountCell.textContent = items.length;
                        } catch (parseError) {
                            statusCell.innerHTML = `<span class="badge badge-success">OK (${endTime - startTime}ms)</span>`;
                            lastCheckedCell.textContent = timeString;
                            itemCountCell.textContent = 'N/A';
                        }
                    } else {
                        statusCell.innerHTML = `<span class="badge badge-danger">Error (${response.status})</span>`;
                        lastCheckedCell.textContent = timeString;
                        itemCountCell.textContent = 'N/A';
                    }
                } catch (error) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    statusCell.innerHTML = '<span class="badge badge-danger">Failed</span>';
                    lastCheckedCell.textContent = timeString;
                    itemCountCell.textContent = 'N/A';
                    console.error(`Error checking ${feed.route}:`, error);
                }
            }

            loadingIndicator.style.display = 'none';
        }

        // Add event listener to the check status button
        checkStatusBtn.addEventListener('click', checkStatus);

        // Check status on page load
        checkStatus();
    });
</script>
{% endblock content %}